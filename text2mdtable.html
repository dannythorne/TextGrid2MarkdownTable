<!DOCTYPE html>
<html>
<head>
<title>text2mdtable</title>
<style>
body
{
  background-color:#f0f0f0;
}
</style>
</head>
<body>

<div id="console">
</div>

<div id="table">
</div>

<div id="markdown">
</div>

<script>
window.onload = function()
{
  main();
}

var textarea_rows = 16;
var textarea_cols = 128;

function main()
{
  var form = document.createElement("form");

  var textarea = document.createElement("textarea");
  textarea.rows = textarea_rows;
  textarea.cols = textarea_cols;
  textarea.value = "";
  textarea.value+= "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor";
  textarea.value+= "\nincididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis";
  textarea.value+= "\nnostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.";
  textarea.value+= "\nDuis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu";
  textarea.value+= "\nfugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in";
  textarea.value+= "\nculpa qui officia deserunt mollit anim id est laborum.";

  textarea.style.fontFamily = "monospace";
  form.appendChild(document.createTextNode("Paste lines of text here:"));
  form.appendChild(document.createElement("br"));
  form.appendChild(textarea);
  form.appendChild(document.createElement("br"));

  var button = document.createElement("button");
  button.type = "button";
  button.innerHTML = "Make Table";
  button.onclick = make_table_interface; 
  form.appendChild(button);

  document.getElementById("table").appendChild(form);
}

var str;
var num_cols;
var num_rows;
var words_per_cell;
var max_words_per_cell;
var max_words_per_line;

function make_table_interface()
{
  var console = document.getElementById("console");

  var textarea = document.getElementsByTagName("textarea");
  str = textarea[0].value;

  var table = document.getElementById("table");
  table.style.marginTop = "1em";

  var markdown = document.getElementById("markdown");
  markdown.style.marginTop = "1em";

  // remove the form
  var form = document.getElementsByTagName("form");
  table.removeChild(form[0]);

  //############################################################################
  //
  // produce markdown
  //

  str = str.split(/\n/); // string array for each line

  // TODO: remove empty lines?

  var iline;
  var iword;
  var line;
  var temp;
  num_rows = str.length;
  var icol;

  words_per_cell = [];
  var min_words_per_line;
  max_words_per_cell;

  // split each line into array of words
  for( iline=0; iline<num_rows; iline++)
  {
    str[iline] = str[iline].trim().split(/ [ ]*/g);
  }

  max_words_per_line = 0;
  for( iline=0; iline<num_rows; iline++)
  {
    if( max_words_per_line < str[iline].length)
    {
      max_words_per_line = str[iline].length;
    }
  }

  // compute min number of words per row
  min_words_per_line = str[0].length;
  for( iline=1; iline<num_rows; iline++)
  {
    if( str[iline].length<min_words_per_line)
    {
      min_words_per_line = str[iline].length;
    }
  }

  // init default number of columns
  if( min_words_per_line < 2)
  {
    num_cols = 1;
  }
  else if( min_words_per_line < 8)
  {
    num_cols = 2;
  }
  else
  {
    num_cols = 4;
  }

  compute_table();

  if( false /*show words per cell*/)
  {
    for( iline=0; iline<num_rows; iline++)
    {
      table.innerHTML += "<br/>";
      for( icol=0; icol<num_cols; icol++)
      {
        table.innerHTML+=" ";
        table.innerHTML+=words_per_cell[iline][icol];
      }
    }
  }

  // display markdown for table with default number of columns
  // and uniform distribution of words in each row

  if( false /* diagnostic version: cell for every word*/)
  {
    for( iline=0; iline<num_rows; iline++)
    {
      table.innerHTML += "<br/>";

      for( iword = 0; iword<str[iline].length; iword++)
      {
        table.innerHTML += " | "+str[iline][iword];
      }
      table.innerHTML += " | ";
    }
    table.style.fontFamily = "monospace";
  }

  var button_for_new_col = document.createElement("button");
  var button_for_del_col = document.createElement("button");

  button_for_new_col.type = "button";
  button_for_del_col.type = "button";

  button_for_new_col.innerHTML = "+";
  button_for_del_col.innerHTML = "&minus;";

  button_for_new_col.onclick = add_a_column;
  button_for_del_col.onclick = del_a_column;

  table.appendChild(button_for_new_col);
  table.appendChild(document.createTextNode(" More columns"));

  table.appendChild(document.createElement("br"));

  table.appendChild(button_for_del_col);
  table.appendChild(document.createTextNode(" Less columns"));

  var container = document.createElement("div");
  container.style.marginTop = "1em";
  container.id = "container";
  table.appendChild(container);

  make_table();

}

function compute_table()
{
  // compute average words per cell
  for( iline=0; iline<num_rows; iline++)
  {
    words_per_cell[iline] = str[iline].length / num_cols;
  }

  // start with each cell getting roughly equal share of words in its row
  for( iline=0; iline<num_rows; iline++)
  {
    temp = Math.floor(words_per_cell[iline]);
    words_per_cell[iline] = [];
    for( icol=0; icol<num_cols; icol++)
    {
      words_per_cell[iline][icol] = temp;
    }
    for( icol=0; icol<str[iline].length-temp*num_cols; icol++)
    {
      words_per_cell[iline][icol]++;
    }
  }

  compute_max_words_per_cell_per_column();

}

function compute_max_words_per_cell_per_column()
{
  var icol;
  var iline;
  max_words_per_cell = [];
  for( icol=0; icol<num_cols; icol++)
  {
    max_words_per_cell[icol] = 0;
    for( iline=0; iline<num_rows; iline++)
    {
      if( max_words_per_cell[icol] < words_per_cell[iline][icol])
      {
        max_words_per_cell[icol] = words_per_cell[iline][icol];
      }
    }
  }
}

function make_table()
{
  var container = document.getElementById("container");
  while( container.childNodes.length > 0)
  {
    container.removeChild(container.firstChild);
  }

  var markdown = document.getElementById("markdown");
  while( markdown.childNodes.length > 0)
  {
    markdown.removeChild(markdown.firstChild);
  }

  var row;
  var cell;
  var word;
  var button;

  var i, j;

  for( iline=0; iline<num_rows; iline++)
  {
    row = document.createElement("div");
    row.style.marginTop = "4px";
    row.style.marginBottom = "4px";
    container.appendChild(row);

    iword = 0;

    for( icol = 0; icol<num_cols; icol++)
    {
      cell = document.createElement("span");
      row.appendChild(cell);

      if( iline==0)
      {
        cell.style.borderBottom = "solid 1px #000000";
        cell.style.fontWeight = "bold";
      }

      for( i=0; i<words_per_cell[iline][icol]; i++)
      {
        word = document.createElement("span");
        word.style.backgroundColor = "#e0e0e0";
        word.style.borderRadius = "2px";
        cell.appendChild(word);

        word.style.paddingLeft = "2px";
        word.style.paddingRight = "2px";
        word.style.marginLeft = "2px";
        word.style.marginRight = "2px";
        word.style.borderRight = "solid 1px #e0e0e0";
        word.innerHTML += str[iline][iword].substr(0,4);
        if( str[iline][iword].length < 4)
        {
          for( j=4; j>str[iline][iword].length; j--)
          {
            word.innerHTML += "&nbsp;";
          }
        }
        else if( str[iline][iword].length > 4)
        {
          word.style.borderRight = "dashed 1px #c09090";
          word.title = str[iline][iword];
        }
        iword++;

      }

      // fill rest of cell to match max cell size in this column
      for( ; i<max_words_per_cell[icol]; i++)
      {
        word = document.createElement("span");
        cell.appendChild(word);

        word.style.paddingLeft = "2px";
        word.style.paddingRight = "2px";
        word.style.marginLeft = "2px";
        word.style.marginRight = "2px";
        word.style.borderRight = "solid 1px #f0f0f0";
        word.innerHTML += "&nbsp;&nbsp;&nbsp;&nbsp;";
      }

      if( icol<num_cols-1)
      {
        button = document.createElement("button");
        button.type = "button";
        button.innerHTML = "&lt;";
        button.id = iline+" "+icol+" left";
        button.addEventListener( "click", function() { move_partition_left( this);}, false);
        row.appendChild(button);

        row.appendChild(document.createTextNode("|"));

        button = document.createElement("button");
        button.type = "button";
        button.innerHTML = "&gt;";
        button.id = iline+" "+icol+" right";
        button.addEventListener( "click", function() { move_partition_right( this);}, false);
        row.appendChild(button);
      }
    }
  }
  container.style.fontFamily = "monospace";

  put_markdown_in_textarea_for_copying();
}

function add_a_column()
{
  if( num_cols<max_words_per_line)
  {
    num_cols++;
    //document.getElementById("console").innerHTML += "["+num_cols+"]";
    compute_table();
    make_table();
  }
  else
  {
    //document.getElementById("console").innerHTML += "["+num_cols+"]";
  }

}

function del_a_column()
{
  if( num_cols > 1)
  {
    num_cols--;
    //document.getElementById("console").innerHTML += "["+num_cols+"]";
    compute_table();
    make_table();
  }
  else
  {
    //document.getElementById("console").innerHTML += "["+num_cols+"]";
  }

}

function move_partition_left( my)
{
  var i = my.id.split(" ");
  var row = parseInt(i[0]);
  var col = parseInt(i[1]);
  if( words_per_cell[ row ][ col ] > 0)
  {
    words_per_cell[ row ][ col   ]--;
    words_per_cell[ row ][ col+1 ]++;
    compute_max_words_per_cell_per_column();
    make_table();
    //document.getElementById("console").innerHTML += "left";
  }

}

function move_partition_right( my)
{
  var i = my.id.split(" ");
  var row = parseInt(i[0]);
  var col = parseInt(i[1]);
  if( words_per_cell[ row ][ col+1 ] > 0)
  {
    //document.getElementById("console").innerHTML += "right";
    words_per_cell[ row ][ col   ]++;
    words_per_cell[ row ][ col+1 ]--;
    compute_max_words_per_cell_per_column();
    make_table();
  }

}

function put_markdown_in_textarea_for_copying()
{
  var markdown = document.getElementById("markdown");
  var x = document.createElement("span");
  x.innerHTML = "Markdown to copy (Windows: Ctrl+C) (OS X: &#8984;C):";
  markdown.appendChild(x);
  markdown.appendChild(document.createElement("br"));

  var chars_per_cell = [];
  var max_chars_per_cell_per_column = [];

  var iline;
  var iword;
  var icol;

  for( iline=0; iline<num_rows; iline++)
  {
    chars_per_cell[iline] = [];
    for( icol=0; icol<num_cols; icol++)
    {
      chars_per_cell[iline][icol] = 0;
    }
  }

  // count chars per cell
  for( iline=0; iline<num_rows; iline++)
  {
    iword = 0;

    for( icol=0; icol<num_cols; icol++)
    {
      chars_per_cell[iline][icol] = 0;
      for( i=0; i<words_per_cell[iline][icol]; i++)
      {
        chars_per_cell[iline][icol] += str[iline][iword].length;
        iword++;
      }
      chars_per_cell[iline][icol] += words_per_cell[iline][icol]-1; // count the in between spaces
    }
  }

  // compute max chars per cell per column
  for( icol=0; icol<num_cols; icol++)
  {
    max_chars_per_cell_per_column[icol] = 0;

    for( iline=0; iline<num_rows; iline++)
    {
      if( max_chars_per_cell_per_column[icol] < chars_per_cell[iline][icol])
      {
        max_chars_per_cell_per_column[icol] = chars_per_cell[iline][icol];
      }
    }
  }

  // accumulate textarea value string
  var val = "";

  if( false /* diagnostics */)
  {
    for( iline=0; iline<num_rows; iline++)
    {
      val+=" | ";

      for( icol=0; icol<num_cols; icol++)
      {
        val += words_per_cell[iline][icol]+" "+chars_per_cell[iline][icol]+" "+max_chars_per_cell_per_column[icol];
        val+=" | ";
      }
      val += "\n";
    }
  }

  // columns nicely lined up (or are they?)
  for( iline=0; iline<num_rows; iline++)
  {
    if( iline==1)
    {
      // hline

      val+=" |-";

      iword = 0;

      for( icol=0; icol<num_cols; icol++)
      {
        for( i=0; i<max_chars_per_cell_per_column[icol]; i++)
        {
          val+="-";
        }
        val+="-|";
        if( icol<num_cols-1)
        {
          val+="-";
        }
      }
      val += "\n";
    }

    val+=" | ";

    iword = 0;

    for( icol=0; icol<num_cols; icol++)
    {
      for( i=0; i<words_per_cell[iline][icol]; i++)
      {
        val+=str[iline][iword];
        if( i<words_per_cell[iline][icol]-1)
        {
          val+=" ";
        }
        iword++;
      }

      for( i=max_chars_per_cell_per_column[icol]; i>chars_per_cell[iline][icol]; i--)
      {
        val+=" ";
      }
      val+=" | ";
    }
    val += "\n";
  }

  var textarea = document.createElement("textarea");
  textarea.value = val;
  textarea.rows = num_rows+2;
  textarea.cols = textarea_cols;
  textarea.style.fontFamily = "monospace";
  markdown.appendChild(textarea);
  textarea.select();
}

</script>



</body>
</html>
