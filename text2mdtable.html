<!DOCTYPE html>
<html>
<head>
<title>text2mdtable</title>
</head>
<body>

<div id="console">
</div>

<div id="table">
</div>

<script>
window.onload = function()
{
  main();
}

function main()
{
  var form = document.createElement("form");

  var textarea = document.createElement("textarea");
  textarea.rows = "32";
  textarea.cols = "128";
  textarea.value = "asdf asdf asdf sadf asdf asdf asdf asdf\nasdf asdf asdf asdf asdf asdf asdf asdf asdf asdf asdf";
  textarea.style.fontFamily = "monospace";
  form.appendChild(textarea);

  var button = document.createElement("button");
  button.type = "button";
  button.innerHTML = "Make Table";
  button.onclick = make_table_interface; 
  form.appendChild(button);

  document.getElementById("table").appendChild(form);
}

var str;
var num_cols;
var num_rows;
var words_per_cell;
var max_words_per_cell;
var max_words_per_line;

function make_table_interface()
{
  var console = document.getElementById("console");

  var textarea = document.getElementsByTagName("textarea");
  str = textarea[0].value;

  var table = document.getElementById("table");
  table.style.marginTop = "1em";

  // remove the form
  var form = document.getElementsByTagName("form");
  table.removeChild(form[0]);

  //############################################################################
  //
  // produce markdown
  //

  str = str.split(/\n/); // string array for each line

  // TODO: remove empty lines?

  var iline;
  var iword;
  var line;
  var temp;
  num_rows = str.length;
  var icol;

  words_per_cell = [];
  var min_words_per_line;
  max_words_per_cell;

  // split each line into array of words
  for( iline=0; iline<num_rows; iline++)
  {
    str[iline] = str[iline].trim().split(" ");
  }

  max_words_per_line = 0;
  for( iline=0; iline<num_rows; iline++)
  {
    if( max_words_per_line < str[iline].length)
    {
      max_words_per_line = str[iline].length;
    }
  }

  // compute min number of words per row
  min_words_per_line = str[0].length;
  for( iline=1; iline<num_rows; iline++)
  {
    if( str[iline].length<min_words_per_line)
    {
      min_words_per_line = str[iline].length;
    }
  }

  // init default number of columns
  if( min_words_per_line < 2)
  {
    num_cols = 1;
  }
  else if( min_words_per_line < 8)
  {
    num_cols = 2;
  }
  else
  {
    num_cols = 4;
  }

  compute_table();

  if( false /*show words per cell*/)
  {
    for( iline=0; iline<num_rows; iline++)
    {
      table.innerHTML += "<br/>";
      for( icol=0; icol<num_cols; icol++)
      {
        table.innerHTML+=" ";
        table.innerHTML+=words_per_cell[iline][icol];
      }
    }
  }

  // display markdown for table with default number of columns
  // and uniform distribution of words in each row

  if( false /* diagnostic version: cell for every word*/)
  {
    for( iline=0; iline<num_rows; iline++)
    {
      table.innerHTML += "<br/>";

      for( iword = 0; iword<str[iline].length; iword++)
      {
        table.innerHTML += " | "+str[iline][iword];
      }
      table.innerHTML += " | ";
    }
    table.style.fontFamily = "monospace";
  }

  var button_for_new_col = document.createElement("button");
  var button_for_del_col = document.createElement("button");

  button_for_new_col.type = "button";
  button_for_del_col.type = "button";

  button_for_new_col.innerHTML = "+";
  button_for_del_col.innerHTML = "-";

  button_for_new_col.onclick = add_a_column;
  button_for_del_col.onclick = del_a_column;

  table.appendChild(button_for_del_col);
  table.appendChild(button_for_new_col);

  var container = document.createElement("div");
  container.id = "container";
  table.appendChild(container);

  make_table();

}

function compute_table()
{
  // compute average words per cell
  for( iline=0; iline<num_rows; iline++)
  {
    words_per_cell[iline] = str[iline].length / num_cols;
  }

  // start with each cell getting roughly equal share of words in its row
  for( iline=0; iline<num_rows; iline++)
  {
    temp = Math.floor(words_per_cell[iline]);
    words_per_cell[iline] = [];
    for( icol=0; icol<num_cols; icol++)
    {
      words_per_cell[iline][icol] = temp;
    }
    for( icol=0; icol<str[iline].length-temp*num_cols; icol++)
    {
      words_per_cell[iline][icol]++;
    }
  }

  compute_max_words_per_cell_per_column();

}

function compute_max_words_per_cell_per_column()
{
  var icol;
  var iline;
  max_words_per_cell = [];
  for( icol=0; icol<num_cols; icol++)
  {
    max_words_per_cell[icol] = 0;
    for( iline=0; iline<num_rows; iline++)
    {
      if( max_words_per_cell[icol] < words_per_cell[iline][icol])
      {
        max_words_per_cell[icol] = words_per_cell[iline][icol];
      }
    }
  }
}

function make_table()
{
  var container = document.getElementById("container");
  while( container.childNodes.length > 0)
  {
    container.removeChild(container.firstChild);
  }

  var row;
  var cell;
  var word;
  var button;

  for( iline=0; iline<num_rows; iline++)
  {
    row = document.createElement("div");
    row.style.marginTop = "4px";
    row.style.marginBottom = "4px";
    container.appendChild(row);

    iword = 0;

    for( icol = 0; icol<num_cols; icol++)
    {
      cell = document.createElement("span");
      row.appendChild(cell);

      for( i=0; i<words_per_cell[iline][icol]; i++)
      {
        word = document.createElement("span");
        cell.appendChild(word);

        word.style.paddingLeft = "2px";
        word.style.paddingRight = "2px";
        word.style.marginLeft = "2px";
        word.style.marginRight = "2px";
        word.innerHTML += str[iline][iword];
        iword++;

      }

      // fill rest of cell to match max cell size in this column
      for( ; i<max_words_per_cell[icol]; i++)
      {
        word = document.createElement("span");
        cell.appendChild(word);

        word.style.paddingLeft = "2px";
        word.style.paddingRight = "2px";
        word.style.marginLeft = "2px";
        word.style.marginRight = "2px";
        word.innerHTML += "&nbsp;&nbsp;&nbsp;&nbsp;";
      }

      if( icol<num_cols-1)
      {
        button = document.createElement("button");
        button.type = "button";
        button.innerHTML = "&lt;";
        button.id = iline+" "+icol+" left";
        button.addEventListener( "click", function() { move_partition_left( this);}, false);
        row.appendChild(button);

        row.appendChild(document.createTextNode("|"));

        button = document.createElement("button");
        button.type = "button";
        button.innerHTML = "&gt;";
        button.id = iline+" "+icol+" right";
        button.addEventListener( "click", function() { move_partition_right( this);}, false);
        row.appendChild(button);
      }
    }
  }
  container.style.fontFamily = "monospace";

}

function add_a_column()
{
  if( num_cols<max_words_per_line)
  {
    num_cols++;
    document.getElementById("console").innerHTML += "["+num_cols+"]";
    compute_table();
    make_table();
  }
  else
  {
    document.getElementById("console").innerHTML += "["+num_cols+"]";
  }
}

function del_a_column()
{
  if( num_cols > 1)
  {
    num_cols--;
    document.getElementById("console").innerHTML += "["+num_cols+"]";
    compute_table();
    make_table();
  }
  else
  {
    document.getElementById("console").innerHTML += "["+num_cols+"]";
  }
}

function move_partition_left( my)
{
  var i = my.id.split(" ");
  var row = parseInt(i[0]);
  var col = parseInt(i[1]);
  if( words_per_cell[ row ][ col ] > 0)
  {
    words_per_cell[ row ][ col   ]--;
    words_per_cell[ row ][ col+1 ]++;
    compute_max_words_per_cell_per_column();
    make_table();
    document.getElementById("console").innerHTML += "left";
  }
}

function move_partition_right( my)
{
  var i = my.id.split(" ");
  var row = parseInt(i[0]);
  var col = parseInt(i[1]);
  if( words_per_cell[ row ][ col+1 ] > 0)
  {
    document.getElementById("console").innerHTML += "right";
    words_per_cell[ row ][ col   ]++;
    words_per_cell[ row ][ col+1 ]--;
    compute_max_words_per_cell_per_column();
    make_table();
  }
}

</script>

</body>
</html>
